#!/usr/bin/env bash
set -euo pipefail

# Ubuntu 22.04.x misconfiguration / hardening audit (read-only checks)
# Run: sudo bash ubuntu_audit.sh
# Output: terminal + a report file

REPORT="ubuntu_audit_$(hostname)_$(date +%F_%H%M%S).txt"
exec > >(tee -a "$REPORT") 2>&1

section() { echo -e "\n==== $* ====\n"; }
ok()      { echo "[OK]    $*"; }
warn()    { echo "[WARN]  $*"; }
info()    { echo "[INFO]  $*"; }

require_root() {
  if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
    echo "Please run as root: sudo $0"
    exit 1
  fi
}

cmd_exists() { command -v "$1" >/dev/null 2>&1; }

require_root

section "System Info"
info "Hostname: $(hostname)"
info "OS: $(. /etc/os-release && echo "$PRETTY_NAME")"
info "Kernel: $(uname -r)"
info "Uptime: $(uptime -p)"
info "Report: $REPORT"

section "Users & Authentication"
# Root login shell
if passwd -S root 2>/dev/null | grep -q " L "; then
  ok "root account appears locked (passwd -S root)"
else
  warn "root account may not be locked (check 'passwd -S root')"
fi

# Empty password accounts
EMPTY_PW_USERS="$(awk -F: '($2==""){print $1}' /etc/shadow || true)"
if [[ -z "$EMPTY_PW_USERS" ]]; then
  ok "No accounts with empty password hashes found"
else
  warn "Accounts with empty password hashes: $EMPTY_PW_USERS"
fi

# UID 0 accounts besides root
UID0_USERS="$(awk -F: '($3==0){print $1}' /etc/passwd | tr '\n' ' ')"
if [[ "$UID0_USERS" == "root " ]]; then
  ok "Only root has UID 0"
else
  warn "Multiple UID 0 accounts detected: $UID0_USERS"
fi

# Sudoers basic check
if grep -R "NOPASSWD" /etc/sudoers /etc/sudoers.d 2>/dev/null | grep -vE '^\s*#' >/dev/null; then
  warn "NOPASSWD sudo rules found (passwordless sudo)"
else
  ok "No obvious NOPASSWD sudo rules found"
fi

section "SSH Configuration"
if systemctl is-enabled ssh >/dev/null 2>&1 || systemctl is-enabled sshd >/dev/null 2>&1; then
  info "SSH service is enabled"
else
  info "SSH service does not appear enabled"
fi

SSHD_CONFIG="/etc/ssh/sshd_config"
if [[ -f "$SSHD_CONFIG" ]]; then
  # Root login
  if grep -Eiq '^\s*PermitRootLogin\s+yes' "$SSHD_CONFIG"; then
    warn "SSHD: PermitRootLogin is set to YES"
  else
    ok "SSHD: PermitRootLogin not set to YES (good)"
  fi

  # Password auth
  if grep -Eiq '^\s*PasswordAuthentication\s+yes' "$SSHD_CONFIG"; then
    warn "SSHD: PasswordAuthentication is YES (consider keys-only for admin access)"
  else
    ok "SSHD: PasswordAuthentication not explicitly YES (or disabled)"
  fi

  # Weak ciphers/mac/kex (very rough heuristic)
  if grep -Eiq '^\s*(Ciphers|MACs|KexAlgorithms)\s+' "$SSHD_CONFIG"; then
    info "SSHD: Custom crypto settings detected (review for legacy algorithms)"
  else
    info "SSHD: Using distro defaults for crypto settings"
  fi
else
  info "No sshd_config found (SSH may not be installed)"
fi

section "Firewall & Network Exposure"
if cmd_exists ufw; then
  UFW_STATUS="$(ufw status 2>/dev/null || true)"
  if echo "$UFW_STATUS" | grep -qi "Status: active"; then
    ok "UFW is active"
  else
    warn "UFW is not active"
  fi
else
  info "ufw not installed"
fi

# Listening services (informational)
if cmd_exists ss; then
  info "Listening TCP/UDP sockets (ss -tulpen):"
  ss -tulpen || true
else
  info "ss command not available"
fi

section "Updates & Patch Management"
if cmd_exists unattended-upgrades; then
  ok "unattended-upgrades is installed"
else
  warn "unattended-upgrades is NOT installed"
fi

AUTO_UPGRADES="/etc/apt/apt.conf.d/20auto-upgrades"
if [[ -f "$AUTO_UPGRADES" ]]; then
  if grep -q 'APT::Periodic::Unattended-Upgrade "1";' "$AUTO_UPGRADES"; then
    ok "Unattended upgrades enabled in 20auto-upgrades"
  else
    warn "Unattended upgrades may be disabled (check /etc/apt/apt.conf.d/20auto-upgrades)"
  fi
else
  warn "No 20auto-upgrades file found"
fi

section "File Permissions & Risky Bits"
# World-writable files/dirs (skip /proc, /sys, /run, container mounts)
info "World-writable directories (top hits, excluding /proc,/sys,/run):"
find / -xdev \( -path /proc -o -path /sys -o -path /run \) -prune -o -type d -perm -0002 -print 2>/dev/null | head -n 30 || true

info "World-writable files (top hits, excluding /proc,/sys,/run):"
find / -xdev \( -path /proc -o -path /sys -o -path /run \) -prune -o -type f -perm -0002 -print 2>/dev/null | head -n 30 || true

# SUID/SGID binaries (informational)
info "SUID binaries (top hits):"
find / -xdev -type f -perm -4000 -print 2>/dev/null | head -n 40 || true

info "SGID binaries (top hits):"
find / -xdev -type f -perm -2000 -print 2>/dev/null | head -n 40 || true

section "Kernel / Sysctl Basics"
SYSCTL_FILE="/etc/sysctl.conf"
# IP forwarding
IPF="$(sysctl -n net.ipv4.ip_forward 2>/dev/null || echo "unknown")"
if [[ "$IPF" == "1" ]]; then
  warn "net.ipv4.ip_forward is enabled (1) â€” may be intended for routers, risky otherwise"
else
  ok "net.ipv4.ip_forward is not enabled (value: $IPF)"
fi

# ICMP redirects acceptance
AR="$(sysctl -n net.ipv4.conf.all.accept_redirects 2>/dev/null || echo "unknown")"
SR="$(sysctl -n net.ipv4.conf.default.accept_redirects 2>/dev/null || echo "unknown")"
if [[ "$AR" == "1" || "$SR" == "1" ]]; then
  warn "ICMP redirect acceptance enabled (all=$AR default=$SR)"
else
  ok "ICMP redirect acceptance disabled (all=$AR default=$SR)"
fi

# Source routing
ASR="$(sysctl -n net.ipv4.conf.all.accept_source_route 2>/dev/null || echo "unknown")"
DSR="$(sysctl -n net.ipv4.conf.default.accept_source_route 2>/dev/null || echo "unknown")"
if [[ "$ASR" == "1" || "$DSR" == "1" ]]; then
  warn "Source routing acceptance enabled (all=$ASR default=$DSR)"
else
  ok "Source routing acceptance disabled (all=$ASR default=$DSR)"
fi

section "Services (quick scan)"
info "Enabled services (systemctl list-unit-files --state=enabled, top hits):"
systemctl list-unit-files --state=enabled --no-pager | head -n 60 || true

section "Summary"
info "Audit complete. Review warnings above."
info "Full report saved to: $REPORT"
